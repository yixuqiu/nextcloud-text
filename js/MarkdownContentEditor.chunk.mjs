/*! third party licenses: js/vendor.LICENSE.txt */
import{C as D,R as j,a as A,M as H,W as _,A as G}from"./Wrapper.chunk.mjs";import{ac as $,P as W,ad as z,E as F,X as U,R as q,W as K,aa as N}from"./RichText.chunk.mjs";import{l as V}from"./modulepreload-polyfill.chunk.mjs";import{i as X,b as J,j as L}from"./MediaHandler.provider.chunk.mjs";import{n as Q}from"./_plugin-vue2_normalizer.chunk.mjs";import"./vue.runtime.esm.chunk.mjs";import"./index.chunk2.mjs";import"./index.chunk3.mjs";import"./emoji-picker.chunk.mjs";import"./index.chunk.mjs";import"./NcUserBubble-DMjZyrGY.chunk.mjs";import"./NcNoteCard-BLPU1den.chunk.mjs";import"./index.chunk4.mjs";import"./index.chunk5.mjs";import"./logger.chunk.mjs";var C=200,u=function(){};u.prototype.append=function(e){return e.length?(e=u.from(e),!this.length&&e||e.length<C&&this.leafAppend(e)||this.length<C&&e.leafPrepend(this)||this.appendInner(e)):this},u.prototype.prepend=function(e){return e.length?u.from(e).append(this):this},u.prototype.appendInner=function(e){return new Y(this,e)},u.prototype.slice=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=this.length),e>=t?u.empty:this.sliceInner(Math.max(0,e),Math.min(this.length,t))},u.prototype.get=function(e){if(!(e<0||e>=this.length))return this.getInner(e)},u.prototype.forEach=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length),t<=n?this.forEachInner(e,t,n,0):this.forEachInvertedInner(e,t,n,0)},u.prototype.map=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length);var i=[];return this.forEach(function(r,o){return i.push(e(r,o))},t,n),i},u.from=function(e){return e instanceof u?e:e&&e.length?new x(e):u.empty};var x=function(e){function t(i){e.call(this),this.values=i}e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t;var n={length:{configurable:!0},depth:{configurable:!0}};return t.prototype.flatten=function(){return this.values},t.prototype.sliceInner=function(i,r){return i==0&&r==this.length?this:new t(this.values.slice(i,r))},t.prototype.getInner=function(i){return this.values[i]},t.prototype.forEachInner=function(i,r,o,s){for(var a=r;a<o;a++)if(i(this.values[a],s+a)===!1)return!1},t.prototype.forEachInvertedInner=function(i,r,o,s){for(var a=r-1;a>=o;a--)if(i(this.values[a],s+a)===!1)return!1},t.prototype.leafAppend=function(i){if(this.length+i.length<=C)return new t(this.values.concat(i.flatten()))},t.prototype.leafPrepend=function(i){if(this.length+i.length<=C)return new t(i.flatten().concat(this.values))},n.length.get=function(){return this.values.length},n.depth.get=function(){return 0},Object.defineProperties(t.prototype,n),t}(u);u.empty=new x([]);var Y=function(e){function t(n,i){e.call(this),this.left=n,this.right=i,this.length=n.length+i.length,this.depth=Math.max(n.depth,i.depth)+1}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},t.prototype.getInner=function(n){return n<this.left.length?this.left.get(n):this.right.get(n-this.left.length)},t.prototype.forEachInner=function(n,i,r,o){var s=this.left.length;if(i<s&&this.left.forEachInner(n,i,Math.min(r,s),o)===!1||r>s&&this.right.forEachInner(n,Math.max(i-s,0),Math.min(this.length,r)-s,o+s)===!1)return!1},t.prototype.forEachInvertedInner=function(n,i,r,o){var s=this.left.length;if(i>s&&this.right.forEachInvertedInner(n,i-s,Math.max(r,s)-s,o+s)===!1||r<s&&this.left.forEachInvertedInner(n,Math.min(i,s),r,o)===!1)return!1},t.prototype.sliceInner=function(n,i){if(n==0&&i==this.length)return this;var r=this.left.length;return i<=r?this.left.slice(n,i):n>=r?this.right.slice(n-r,i-r):this.left.slice(n,r).append(this.right.slice(0,i-r))},t.prototype.leafAppend=function(n){var i=this.right.leafAppend(n);if(i)return new t(this.left,i)},t.prototype.leafPrepend=function(n){var i=this.left.leafPrepend(n);if(i)return new t(i,this.right)},t.prototype.appendInner=function(n){return this.left.depth>=Math.max(this.right.depth,n.depth)+1?new t(this.left,new t(this.right,n)):new t(this,n)},t}(u),k=u;const Z=500;class m{constructor(t,n){this.items=t,this.eventCount=n}popEvent(t,n){if(this.eventCount==0)return null;let i=this.items.length;for(;;i--)if(this.items.get(i-1).selection){--i;break}let r,o;n&&(r=this.remapping(i,this.items.length),o=r.maps.length);let s=t.tr,a,h,d=[],c=[];return this.items.forEach((l,p)=>{if(!l.step){r||(r=this.remapping(i,p+1),o=r.maps.length),o--,c.push(l);return}if(r){c.push(new g(l.map));let f=l.step.map(r.slice(o)),y;f&&s.maybeStep(f).doc&&(y=s.mapping.maps[s.mapping.maps.length-1],d.push(new g(y,void 0,void 0,d.length+c.length))),o--,y&&r.appendMap(y,o)}else s.maybeStep(l.step);if(l.selection)return a=r?l.selection.map(r.slice(o)):l.selection,h=new m(this.items.slice(0,i).append(c.reverse().concat(d)),this.eventCount-1),!1},this.items.length,0),{remaining:h,transform:s,selection:a}}addTransform(t,n,i,r){let o=[],s=this.eventCount,a=this.items,h=!r&&a.length?a.get(a.length-1):null;for(let c=0;c<t.steps.length;c++){let l=t.steps[c].invert(t.docs[c]),p=new g(t.mapping.maps[c],l,n),f;(f=h&&h.merge(p))&&(p=f,c?o.pop():a=a.slice(0,a.length-1)),o.push(p),n&&(s++,n=void 0),r||(h=p)}let d=s-i.depth;return d>et&&(a=tt(a,d),s-=d),new m(a.append(o),s)}remapping(t,n){let i=new z;return this.items.forEach((r,o)=>{let s=r.mirrorOffset!=null&&o-r.mirrorOffset>=t?i.maps.length-r.mirrorOffset:void 0;i.appendMap(r.map,s)},t,n),i}addMaps(t){return this.eventCount==0?this:new m(this.items.append(t.map(n=>new g(n))),this.eventCount)}rebased(t,n){if(!this.eventCount)return this;let i=[],r=Math.max(0,this.items.length-n),o=t.mapping,s=t.steps.length,a=this.eventCount;this.items.forEach(p=>{p.selection&&a--},r);let h=n;this.items.forEach(p=>{let f=o.getMirror(--h);if(f==null)return;s=Math.min(s,f);let y=o.maps[f];if(p.step){let B=t.steps[f].invert(t.docs[f]),b=p.selection&&p.selection.map(o.slice(h+1,f));b&&a++,i.push(new g(y,B,b))}else i.push(new g(y))},r);let d=[];for(let p=n;p<s;p++)d.push(new g(o.maps[p]));let c=this.items.slice(0,r).append(d).append(i),l=new m(c,a);return l.emptyItemCount()>Z&&(l=l.compress(this.items.length-i.length)),l}emptyItemCount(){let t=0;return this.items.forEach(n=>{n.step||t++}),t}compress(t=this.items.length){let n=this.remapping(0,t),i=n.maps.length,r=[],o=0;return this.items.forEach((s,a)=>{if(a>=t)r.push(s),s.selection&&o++;else if(s.step){let h=s.step.map(n.slice(i)),d=h&&h.getMap();if(i--,d&&n.appendMap(d,i),h){let c=s.selection&&s.selection.map(n.slice(i));c&&o++;let l=new g(d.invert(),h,c),p,f=r.length-1;(p=r.length&&r[f].merge(l))?r[f]=p:r.push(l)}}else s.map&&i--},this.items.length,0),new m(k.from(r.reverse()),o)}}m.empty=new m(k.empty,0);function tt(e,t){let n;return e.forEach((i,r)=>{if(i.selection&&t--==0)return n=r,!1}),e.slice(n)}class g{constructor(t,n,i,r){this.map=t,this.step=n,this.selection=i,this.mirrorOffset=r}merge(t){if(this.step&&t.step&&!t.selection){let n=t.step.merge(this.step);if(n)return new g(n.getMap().invert(),n,this.selection)}}}class v{constructor(t,n,i,r,o){this.done=t,this.undone=n,this.prevRanges=i,this.prevTime=r,this.prevComposition=o}}const et=20;function nt(e,t,n,i){let r=n.getMeta(w),o;if(r)return r.historyState;n.getMeta(ot)&&(e=new v(e.done,e.undone,null,0,-1));let s=n.getMeta("appendedTransaction");if(n.steps.length==0)return e;if(s&&s.getMeta(w))return s.getMeta(w).redo?new v(e.done.addTransform(n,void 0,i,M(t)),e.undone,T(n.mapping.maps[n.steps.length-1]),e.prevTime,e.prevComposition):new v(e.done,e.undone.addTransform(n,void 0,i,M(t)),null,e.prevTime,e.prevComposition);if(n.getMeta("addToHistory")!==!1&&!(s&&s.getMeta("addToHistory")===!1)){let a=n.getMeta("composition"),h=e.prevTime==0||!s&&e.prevComposition!=a&&(e.prevTime<(n.time||0)-i.newGroupDelay||!it(n,e.prevRanges)),d=s?I(e.prevRanges,n.mapping):T(n.mapping.maps[n.steps.length-1]);return new v(e.done.addTransform(n,h?t.selection.getBookmark():void 0,i,M(t)),m.empty,d,n.time,a!=null?a:e.prevComposition)}else return(o=n.getMeta("rebased"))?new v(e.done.rebased(n,o),e.undone.rebased(n,o),I(e.prevRanges,n.mapping),e.prevTime,e.prevComposition):new v(e.done.addMaps(n.mapping.maps),e.undone.addMaps(n.mapping.maps),I(e.prevRanges,n.mapping),e.prevTime,e.prevComposition)}function it(e,t){if(!t)return!1;if(!e.docChanged)return!0;let n=!1;return e.mapping.maps[0].forEach((i,r)=>{for(let o=0;o<t.length;o+=2)i<=t[o+1]&&r>=t[o]&&(n=!0)}),n}function T(e){let t=[];return e.forEach((n,i,r,o)=>t.push(r,o)),t}function I(e,t){if(!e)return null;let n=[];for(let i=0;i<e.length;i+=2){let r=t.map(e[i],1),o=t.map(e[i+1],-1);r<=o&&n.push(r,o)}return n}function rt(e,t,n){let i=M(t),r=w.get(t).spec.config,o=(n?e.undone:e.done).popEvent(t,i);if(!o)return null;let s=o.selection.resolve(o.transform.doc),a=(n?e.done:e.undone).addTransform(o.transform,t.selection.getBookmark(),r,i),h=new v(n?a:o.remaining,n?o.remaining:a,null,0,-1);return o.transform.setSelection(s).setMeta(w,{redo:n,historyState:h})}let E=!1,O=null;function M(e){let t=e.plugins;if(O!=t){E=!1,O=t;for(let n=0;n<t.length;n++)if(t[n].spec.historyPreserveItems){E=!0;break}}return E}const w=new $("history"),ot=new $("closeHistory");function st(e={}){return e={depth:e.depth||100,newGroupDelay:e.newGroupDelay||500},new W({key:w,state:{init(){return new v(m.empty,m.empty,null,0,-1)},apply(t,n,i){return nt(n,i,t,e)}},config:e,props:{handleDOMEvents:{beforeinput(t,n){let i=n.inputType,r=i=="historyUndo"?R:i=="historyRedo"?S:null;return r?(n.preventDefault(),r(t.state,t.dispatch)):!1}}}})}function P(e,t){return(n,i)=>{let r=w.getState(n);if(!r||(e?r.undone:r.done).eventCount==0)return!1;if(i){let o=rt(r,n,e);o&&i(t?o.scrollIntoView():o)}return!0}}const R=P(!1,!0),S=P(!0,!0),at=F.create({name:"history",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:e,dispatch:t})=>R(e,t),redo:()=>({state:e,dispatch:t})=>S(e,t)}},addProseMirrorPlugins(){return[st(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-y":()=>this.editor.commands.redo(),"Mod-я":()=>this.editor.commands.undo(),"Shift-Mod-я":()=>this.editor.commands.redo()}}}),pt={name:"MarkdownContentEditor",components:{ContentContainer:D,ReadonlyBar:j,MenuBar:A,MainContainer:H,Wrapper:_},provide(){const e={};return Object.defineProperties(e,{[X]:{get:()=>this.$editor},[J]:{get:()=>{var t;return(t=this.$attachmentResolver)!=null?t:null}},[L]:{get:()=>!0}}),e},props:{fileId:{type:Number,default:null},content:{type:String,required:!0},readOnly:{type:Boolean,default:!1},relativePath:{type:String,default:""},shareToken:{type:String,default:null},showOutlineOutside:{type:Boolean,default:!1}},emits:["update:content"],computed:{htmlContent(){return this.renderHtml(this.content)}},watch:{content(){this.updateContent()}},created(){var e;this.$editor=this.createEditor(),this.$editor.setEditable(!this.readOnly),this.fileId&&(this.$attachmentResolver=new G({currentDirectory:(e=this.relativePath)==null?void 0:e.match(/.*\//),user:V(),shareToken:this.shareToken,fileId:this.fileId}))},updated(){this.$editor.setEditable(!this.readOnly)},beforeDestroy(){this.$editor.destroy()},methods:{renderHtml(e){return U.render(e)},extensions(){return[q.configure({component:this,extensions:[at]})]},createEditor(){return new K({content:this.htmlContent,extensions:this.extensions(),onUpdate:({editor:e})=>{const t=N(this.$editor.schema).serialize(e.state.doc);this.emit("update:content",{json:e.state.doc,markdown:t})},onCreate:({editor:e})=>{this.$emit("ready"),this.$parent.$emit("ready")}})},updateContent(){this.$editor.commands.setContent(this.htmlContent,!0)},outlineToggled(e){this.emit("outline-toggled",e)},emit(e,t){var n;this.$emit(e,t),(n=this.$parent)==null||n.$emit(e,t)}}};var ht=function(){var e=this,t=e._self._c;return t("Wrapper",{attrs:{"content-loaded":!0,"show-outline-outside":e.showOutlineOutside},on:{"outline-toggled":e.outlineToggled}},[t("MainContainer",[e.readOnly?e._t("readonlyBar",function(){return[t("ReadonlyBar")]}):t("MenuBar",{attrs:{autohide:!1}}),t("ContentContainer")],2)],1)},lt=[],ut=Q(pt,ht,lt,!1,null,"8bb60edd",null,null);const $t=ut.exports;export{$t as default};
